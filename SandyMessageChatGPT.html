<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ready èˆ‡ Sandy çš„è¨Šæ¯æ•…äº‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background-image: linear-gradient(to bottom, #f0f4f8, #e0e7ef);
    }
    .chat-bubble {
      max-width: 75%;
      padding: 0.75rem 1rem;
      border-radius: 1.5rem;
      margin-bottom: 1.5rem;
      word-wrap: break-word;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 0;
    }
    .chat-bubble::after {
      content: attr(data-time);
      position: relative;
      display: block;
      font-size: 0.75rem;
      color: #888;
      margin-top: 0.25rem;
    }
    .sandy {
      background-color: #fce7f3;
      align-self: flex-start;
      border-bottom-left-radius: 0;
    }
    .ready {
      background-color: #dbeafe;
      align-self: flex-end;
      border-bottom-right-radius: 0;
    }
    .hint {
      font-size: 0.8rem;
      color: #888;
      margin-top: 0.25rem;
      text-align: center;
    }
    .chat-container {
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      flex-grow: 1;
      scroll-behavior: smooth;
    }
    #historyOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #historyPanel {
      background: white;
      max-height: 80vh;
      width: 90%;
      max-width: 500px;
      overflow-y: auto;
      padding: 1rem;
      border-radius: 1rem;
    }
  </style>
</head>
<body class="p-4">
  <div class="max-w-xl mx-auto bg-white p-4 rounded-xl shadow-md flex flex-col min-h-screen relative">
    <button onclick="toggleHistory()" class="absolute top-2 right-4 text-sm text-blue-500">ğŸ•“ æŸ¥çœ‹å°è©±ç´€éŒ„</button>
    <div id="chat" class="chat-container space-y-2 mb-4"></div>
    <div id="choices" class="flex flex-col space-y-2"></div>
  </div>

  <div id="historyOverlay" onclick="toggleHistory()">
    <div id="historyPanel" onclick="event.stopPropagation()">
      <h2 class="text-lg font-bold mb-2">è¨Šæ¯å›é¡§</h2>
      <div id="historyContent" class="space-y-2 text-sm"></div>
    </div>
  </div>

  <script>
    const chatEl = document.getElementById('chat');
    const choicesEl = document.getElementById('choices');
    const historyOverlay = document.getElementById('historyOverlay');
    const historyContent = document.getElementById('historyContent');

    let state = {
      trust: 0,
      mood: 0,
      dependency: 0,
      scene: 'start',
      history: []
    };

    const scenes = {
      start: {
        message: "Sandyï¼šå”‰â€¦åˆæ˜¯ä¸€å€‹äº‚ä¸ƒå…«ç³Ÿçš„å¤œæ™šã€‚",
        choices: [
          { text: "æ€éº¼äº†ï¼Ÿæƒ³èŠèŠå—ï¼Ÿ", effect: { trust: 1 }, next: 'open_up' },
          { text: "é€™æ¬¡åˆæ˜¯å­¸é•·é‚„æ˜¯ç”·å‹çš„äº‹ï¼Ÿ", effect: { mood: -1 }, next: 'defensive' },
          { text: "æ™šå®‰ï¼Œå¦³ç´¯äº†å°±æ—©é»ä¼‘æ¯ã€‚", effect: {}, next: 'cold' }
        ]
      },
      open_up: {
        message: "Sandyï¼šå­¸å¼Ÿä»Šå¤©åˆå‚³è¨Šæ¯çµ¦æˆ‘ï¼Œæˆ‘çœŸçš„è¦ºå¾—å¾ˆç…©ï¼Œä½†åˆä¸çŸ¥é“æ€éº¼æ‹’çµ•â€¦",
        choices: [
          { text: "å¦‚æœä¸æƒ³ç†ä»–ï¼Œå°±æ˜è¬›å•Šï¼Œå¦³ä¸æ˜¯ä¸€å‘å¾ˆæœæ–·ï¼Ÿ", effect: { mood: -1 }, next: 'challenged' },
          { text: "å¦³æ˜¯ä¸æ˜¯æ€•ä»–å—å‚·ï¼Ÿ", effect: { trust: 1, dependency: 1 }, next: 'soften' },
          { text: "æ‰€ä»¥â€¦å¦³å…¶å¯¦å°ä»–é‚„æœ‰é»åœ¨æ„ï¼Ÿ", effect: { mood: -1 }, next: 'jealousy' }
        ]
      },
      defensive: {
        message: "Sandyï¼šä½ ä¹Ÿä¾†é…¸æˆ‘å•Šï¼ŸåŸä¾†ä½ è·Ÿä»–å€‘ä¸€æ¨£ã€‚",
        choices: [
          { text: "æˆ‘ä¸æ˜¯é…¸ï¼Œæˆ‘åªæ˜¯é—œå¿ƒã€‚", effect: { trust: 1 }, next: 'soften' },
          { text: "â€¦æŠ±æ­‰ï¼Œæˆ‘ä¸è©²é€™æ¨£å•ã€‚", effect: { trust: 0 }, next: 'soften' }
        ]
      },
      cold: {
        message: "Sandyï¼šå—¯â€¦å¥½å§ï¼Œé‚£æ™šå®‰ã€‚",
        choices: []
      },
      challenged: {
        message: "Sandyï¼šä½ æ€éº¼æœƒé€™æ¨£èªªï¼Œæˆ‘å“ªæœ‰æœæ–·â€¦æˆ‘æ ¹æœ¬ä»€éº¼éƒ½æä¸æ¸…æ¥šã€‚",
        choices: [
          { text: "é‚£å°±åˆ¥å‹‰å¼·è‡ªå·±ï¼Œå¦³æœ‰æ¬Šé¸æ“‡å°è‡ªå·±å¥½çš„äº‹ã€‚", effect: { trust: 1, dependency: 1 }, next: 'soften' }
        ]
      },
      soften: {
        message: "Sandyï¼šä½ ç¸½æ˜¯é€™æ¨£â€¦è¬›è©±è®“æˆ‘æœ‰é»å®‰å¿ƒã€‚",
        choices: [
          { text: "é‚£å¦³é¡˜æ„å¤šè®“æˆ‘äº†è§£å¦³å—ï¼Ÿ", effect: { trust: 1 }, next: 'bonding' },
          { text: "åªæ˜¯æˆ‘ä¹Ÿæ“”å¿ƒè‡ªå·±æœƒä¸æœƒåªæ˜¯å…¶ä¸­ä¸€å€‹ã€‚", effect: { mood: -1 }, next: 'defensive2' }
        ]
      },
      jealousy: {
        message: "Sandyï¼šä½ æ˜¯ä¾†å¯©å•æˆ‘ï¼Ÿä½ æ ¹æœ¬ä¸æ‡‚æˆ‘ã€‚",
        choices: []
      },
      defensive2: {
        message: "Sandyï¼šâ€¦â€¦é‚£ä½ æƒ³æ€æ¨£ï¼Ÿæ”¾æ£„å—ï¼Ÿ",
        choices: [
          { text: "ä¸ï¼Œæˆ‘æƒ³æ›´äº†è§£çœŸæ­£çš„å¦³ã€‚", effect: { trust: 1 }, next: 'bonding' }
        ]
      },
      bonding: {
        message: "Sandyï¼šâ€¦â€¦æˆ–è¨±ï¼Œæˆ‘çœŸçš„æœ‰é»æƒ³é è¿‘ä½ çœ‹çœ‹ã€‚",
        choices: [
          { text: "æˆ‘ä¹Ÿä¸€æ¨£ï¼Œæˆ‘æœƒå¥½å¥½é™ªè‘—å¦³ã€‚", effect: { trust: 1, dependency: 1 }, next: 'secret_past' },
          { text: "é‚£å¦³æº–å‚™å¥½é¢å°çœŸæ­£çš„æ„Ÿæƒ…äº†å—ï¼Ÿ", effect: { trust: -1 }, next: 'ending_doubt' }
        ]
      },
      secret_past: {
        message: "Sandyï¼šä½ çŸ¥é“å—â€¦æˆ‘ä»¥å‰æ›¾ç¶“ä¹Ÿè©¦è‘—ç›¸ä¿¡ä¸€å€‹äººï¼Œçµæœè¢«ç•¶å·¥å…·äººåˆ©ç”¨ï¼Œé€£æˆ‘è‡ªå·±éƒ½é–‹å§‹æ‡·ç–‘è‡ªå·±æœ‰æ²’æœ‰åƒ¹å€¼â€¦",
        choices: [
          { text: "æˆ‘ä¸æœƒæ˜¯é‚£æ¨£çš„äººï¼Œå¦³å¯ä»¥æ…¢æ…¢è§€å¯Ÿæˆ‘ã€‚", effect: { trust: 1 }, next: 'trust_building' },
          { text: "è½èµ·ä¾†å¦³çš„å‚·çœŸçš„å¾ˆæ·±â€¦æˆ‘æœƒæ›´å°å¿ƒå°å¾…å¦³ã€‚", effect: { dependency: 1 }, next: 'trust_building' }
        ]
      },
      trust_building: {
        message: "Sandyï¼šâ€¦â€¦è¬è¬ä½ ã€‚çœŸçš„ã€‚å¦‚æœä½ é¡˜æ„ï¼Œæˆ‘æƒ³å†ç›¸ä¿¡ä¸€æ¬¡çœ‹çœ‹ã€‚",
        choices: [
          { text: "é‚£æˆ‘å€‘å°±ä¸€èµ·æ…¢æ…¢ä¾†ï¼Œä¸æ€¥ã€‚", effect: { trust: 1, dependency: 1 }, next: 'ending_intimate' },
          { text: "æˆ‘ä¸æƒ³åªç•¶å€‹å®‰æ…°è§’è‰²ï¼Œæˆ‘å¸Œæœ›æˆ‘å€‘æ˜¯å°ç­‰çš„ã€‚", effect: { mood: -1 }, next: 'ending_distance' }
        ]
      },
      ending_intimate: {
        message: "Sandyï¼šæˆ‘ä¹Ÿå¸Œæœ›æˆ‘å€‘æ˜¯å°ç­‰çš„ã€‚åªæ˜¯ç¾åœ¨çš„æˆ‘ï¼Œéœ€è¦æœ‰äººé¡˜æ„é™ªæˆ‘èµ°ä¸€æ®µã€‚ä½ é¡˜æ„å—ï¼Ÿâ€¦â€¦è¬è¬ä½ ã€‚",
        choices: []
      },
      ending_distance: {
        message: "Sandyï¼šæˆ–è¨±æˆ‘å€‘æƒ³è¦çš„æ±è¥¿ä¸å¤ªä¸€æ¨£å§â€¦ä¸éè¬è¬ä½ æ›¾ç¶“é™ªæˆ‘èªªè©±ã€‚",
        choices: []
      },
      ending_hope: {
        message: "Sandyï¼šå—¯â€¦è¬è¬ä½ ã€‚æˆ‘è¦ºå¾—ï¼Œè‡³å°‘ç¾åœ¨ï¼Œæˆ‘å¯ä»¥ç›¸ä¿¡ä½ ã€‚",
        choices: []
      },
      ending_doubt: {
        message: "Sandyï¼šä½ å¤ªå¿«äº†â€¦æˆ‘é‚„æ²’æº–å‚™å¥½ã€‚å°ä¸èµ·â€¦",
        choices: []
      }
    };

    function getHint() {
      const { trust, mood, dependency } = state;
      if (trust >= 3 && dependency >= 2) return "å¥¹ä¼¼ä¹é–‹å§‹ä¾è³´ä½ ï¼Œç”šè‡³æœ‰é»æœŸå¾…ä½ å¤šé™ªå¥¹ã€‚";
      if (mood < -2) return "Sandyçš„èªæ°£ä¼¼ä¹è¶Šä¾†è¶Šå†·æ·¡ã€‚";
      if (trust < 0) return "å¥¹å¯èƒ½å°ä½ çš„è©±æœ‰é»ä¸ä¿¡ä»»äº†ã€‚";
      if (dependency >= 3) return "å¥¹å¥½åƒæœ‰é»å¤ªä¾è³´ä½ äº†ï¼Œé€™çœŸçš„å¥åº·å—ï¼Ÿ";
      return null;
    }

    function formatTime() {
      const now = new Date();
      return now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
    }

    function renderScene(key) {
      const scene = scenes[key];
      state.scene = key;
      state.history.push(key);

      const msg = document.createElement('div');
      msg.className = 'chat-bubble sandy';
      msg.textContent = scene.message;
      msg.setAttribute('data-time', formatTime());
      chatEl.appendChild(msg);

      const hint = getHint();
      if (hint) {
        const hintEl = document.createElement('div');
        hintEl.className = 'hint';
        hintEl.textContent = 'ï¼ˆç³»çµ±æç¤ºï¼‰' + hint;
        chatEl.appendChild(hintEl);
      }

      setTimeout(() => {
        chatEl.scrollTop = chatEl.scrollHeight;
      }, 100);

      choicesEl.innerHTML = '';

      if (scene.choices.length === 0) {
        const end = document.createElement('div');
        end.className = 'text-center text-sm text-gray-500 mt-4';
        end.textContent = 'ï¼ˆæ•…äº‹å·²çµæŸï¼‰';
        choicesEl.appendChild(end);

        const replay = document.createElement('button');
        replay.className = 'mt-2 text-blue-500 underline';
        replay.textContent = 'é‡æ–°é–‹å§‹';
        replay.onclick = () => location.reload();
        choicesEl.appendChild(replay);
        return;
      }

      scene.choices.forEach(choice => {
        const btn = document.createElement('button');
        btn.className = 'bg-blue-500 text-white px-4 py-2 rounded-xl hover:bg-blue-600 text-left';
        btn.textContent = choice.text;
        btn.onclick = () => {
          Object.entries(choice.effect).forEach(([key, val]) => {
            state[key] += val;
          });

          const reply = document.createElement('div');
          reply.className = 'chat-bubble ready';
          reply.textContent = choice.text;
          reply.setAttribute('data-time', formatTime());
          chatEl.appendChild(reply);

          renderScene(choice.next);
        };
        choicesEl.appendChild(btn);
      });
    }

    function toggleHistory() {
      historyOverlay.style.display = historyOverlay.style.display === 'flex' ? 'none' : 'flex';
      if (historyOverlay.style.display === 'flex') {
        historyContent.innerHTML = '';
        state.history.forEach(key => {
          const entry = document.createElement('div');
          entry.textContent = scenes[key].message;
          historyContent.appendChild(entry);
        });
      }
    }

    renderScene(state.scene);
  </script>
</body>
</html>
